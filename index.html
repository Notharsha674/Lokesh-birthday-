import React, { useState, useRef, useEffect } from 'react';
import {
  StyleSheet,
  Text,
  View,
  Image,
  TouchableOpacity,
  Animated,
  Easing,
  Share, // For sharing text
  ActivityIndicator, // For loading spinner
  Platform, // To check platform for clipboard
} from 'react-native';
import LinearGradient from 'react-native-linear-gradient'; // For background gradient
import Clipboard from '@react-native-clipboard/clipboard'; // For copying text
import NetInfo from '@react-native-community/netinfo'; // For network check

// Main App Component
const App = () => {
  const [giftBoxOpen, setGiftBoxOpen] = useState(false);
  const [gamerFleetMessage, setGamerFleetMessage] = useState("Loading a special message...");
  const [jackBhaiyaMessage, setJackBhaiyaMessage] = useState("Loading a special message...");
  const [isLoading, setIsLoading] = useState(false);

  // Animated values for gift box
  const lidAnimation = useRef(new Animated.Value(0)).current;
  const baseAnimation = useRef(new Animated.Value(0)).current;
  const ribbonAnimation = useRef(new Animated.Value(1)).current; // For fading ribbons

  // Animated values for dialogue boxes
  const gamerFleetDialogueOpacity = useRef(new Animated.Value(0)).current;
  const jackBhaiyaDialogueOpacity = useRef(new Animated.Value(0)).current;
  const gamerFleetDialogueTranslateY = useRef(new Animated.Value(20)).current;
  const jackBhaiyaDialogueTranslateY = useRef(new Animated.Value(20)).current;

  // Function to play a simple sound (placeholder, requires a library like react-native-sound)
  const playSound = () => {
    // In a real React Native app, you would use a library like 'react-native-sound'
    // For example:
    // import Sound from 'react-native-sound';
    // const sound = new Sound('celebration.mp3', Sound.MAIN_BUNDLE, (error) => {
    //   if (error) {
    //     console.log('failed to load the sound', error);
    //     return;
    //   }
    //   sound.play((success) => {
    //     if (!success) {
    //       console.log('playback failed due to audio decoding errors');
    //     }
    //   });
    // });
    console.log("Playing a celebratory sound!");
  };

  // Function to fetch messages from Gemini API
  const fetchGeminiMessage = async (persona, setMessage) => {
    setIsLoading(true);
    let chatHistory = [];
    let prompt = "";

    if (persona === "gamerFleet") {
      prompt = "Generate a short, enthusiastic birthday message (max 30 words) for a gamer named Lokesh from 'Gamer Fleet'. Use gaming terms like 'GGs', 'level up', 'grinding', 'conquering', 'ping', 'frame rate'.";
    } else if (persona === "jackBhaiya") {
      prompt = "Generate a short, friendly, and encouraging birthday message (max 30 words) for Lokesh from 'Jack Bhaiya'. Use some Hindi slang like 'Kya baat hai', 'hardik shubhkamnayein', 'chill karo', 'chicken dinners'.";
    }

    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
    const payload = { contents: chatHistory };
    const apiKey = ""; // Canvas will automatically provide this at runtime.

    // Exponential backoff retry logic
    const maxRetries = 5;
    let retries = 0;
    let delay = 1000; // 1 second

    while (retries < maxRetries) {
      try {
        const netInfoState = await NetInfo.fetch();
        if (!netInfoState.isConnected) {
          setMessage("No internet connection. Please try again later.");
          setIsLoading(false);
          return;
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
          const text = result.candidates[0].content.parts[0].text;
          setMessage(text);
          setIsLoading(false);
          return; // Success, exit loop
        } else {
          throw new Error("Unexpected API response structure.");
        }
      } catch (error) {
        console.error(`Attempt ${retries + 1} failed:`, error);
        retries++;
        if (retries < maxRetries) {
          await new Promise(res => setTimeout(res, delay));
          delay *= 2; // Exponential backoff
        } else {
          setMessage("Failed to generate message after multiple retries. Please try again.");
          setIsLoading(false);
        }
      }
    }
  };

  // Handle gift box click
  const handleGiftBoxClick = () => {
    if (!giftBoxOpen) {
      setGiftBoxOpen(true);
      playSound(); // Play sound on opening

      // Animate lid
      Animated.timing(lidAnimation, {
        toValue: 1,
        duration: 500,
        easing: Easing.ease,
        useNativeDriver: true,
      }).start();

      // Animate base (slight shrink)
      Animated.timing(baseAnimation, {
        toValue: 1,
        duration: 500,
        easing: Easing.ease,
        useNativeDriver: true,
      }).start();

      // Animate ribbons (fade out)
      Animated.timing(ribbonAnimation, {
        toValue: 0,
        duration: 500,
        easing: Easing.ease,
        useNativeDriver: true,
      }).start(() => {
        // After gift box animation, reveal and animate dialogues
        Animated.parallel([
          Animated.timing(gamerFleetDialogueOpacity, {
            toValue: 1,
            duration: 500,
            easing: Easing.ease,
            useNativeDriver: true,
          }),
          Animated.timing(gamerFleetDialogueTranslateY, {
            toValue: 0,
            duration: 500,
            easing: Easing.ease,
            useNativeDriver: true,
          }),
          Animated.timing(jackBhaiyaDialogueOpacity, {
            toValue: 1,
            duration: 500,
            easing: Easing.ease,
            delay: 300, // Stagger appearance
            useNativeDriver: true,
          }),
          Animated.timing(jackBhaiyaDialogueTranslateY, {
            toValue: 0,
            duration: 500,
            easing: Easing.ease,
            delay: 300, // Stagger appearance
            useNativeDriver: true,
          }),
        ]).start();
      });

      // Fetch messages when the box opens
      fetchGeminiMessage("gamerFleet", setGamerFleetMessage);
      fetchGeminiMessage("jackBhaiya", setJackBhaiyaMessage);
    }
  };

  // Share functionality
  const onShare = async () => {
    try {
      const messageToShare = `Happy Birthday, Lokesh! ðŸŽ‰\n\n${gamerFleetMessage}\n\n${jackBhaiyaMessage}\n\nFrom Ash!`;

      // For Android, Share API is generally preferred.
      // For iOS, Share API also works, but Clipboard is an option for just copying.
      if (Platform.OS === 'android' || Platform.OS === 'ios') {
        await Share.share({
          message: messageToShare,
          title: 'Happy Birthday, Lokesh!',
        });
      } else {
        // Fallback for other platforms (e.g., web preview in some environments)
        Clipboard.setString(messageToShare);
        console.log('Message copied to clipboard!');
        // You might want to add a visual cue that it's copied
      }
    } catch (error) {
      console.error('Error sharing:', error.message);
    }
  };

  // Styles for animated components
  const animatedLidStyle = {
    transform: [
      {
        translateY: lidAnimation.interpolate({
          inputRange: [0, 1],
          outputRange: [0, -200], // Moves up
        }),
      },
      {
        rotateX: lidAnimation.interpolate({
          inputRange: [0, 1],
          outputRange: ['0deg', '45deg'], // Rotates
        }),
      },
    ],
    opacity: lidAnimation.interpolate({
      inputRange: [0, 1],
      outputRange: [1, 0], // Fades out
    }),
  };

  const animatedBaseStyle = {
    transform: [
      {
        scale: baseAnimation.interpolate({
          inputRange: [0, 1],
          outputRange: [1, 0.9], // Shrinks slightly
        }),
      },
    ],
    opacity: baseAnimation.interpolate({
      inputRange: [0, 1],
      outputRange: [1, 0], // Fades out
    }),
  };

  const animatedRibbonStyle = {
    opacity: ribbonAnimation,
  };

  const animatedGamerFleetDialogueStyle = {
    opacity: gamerFleetDialogueOpacity,
    transform: [{ translateY: gamerFleetDialogueTranslateY }],
  };

  const animatedJackBhaiyaDialogueStyle = {
    opacity: jackBhaiyaDialogueOpacity,
    transform: [{ translateY: jackBhaiyaDialogueTranslateY }],
  };

  return (
    <LinearGradient
      colors={['#F9A8D4', '#F472B6', '#EC4899']}
      style={styles.container}
      start={{ x: 0, y: 0 }}
      end={{ x: 1, y: 1 }}
    >
      {/* Background Particles (simplified for RN) */}
      <View style={styles.backgroundParticles}>
        {[...Array(8)].map((_, i) => (
          <Animated.View
            key={i}
            style={[
              styles.particle,
              {
                width: 20 + i * 3, // Vary size
                height: 20 + i * 3,
                top: `${(i * 10 + 10) % 90}%`, // Vary position
                left: `${(i * 15 + 5) % 90}%`,
                // Simple float animation (can be more complex with Animated.loop)
                transform: [{
                  translateY: new Animated.Value(0).interpolate({
                    inputRange: [0, 0.5, 1],
                    outputRange: [0, -20, 0],
                  })
                }],
                opacity: new Animated.Value(0.5).interpolate({
                  inputRange: [0, 0.5, 1],
                  outputRange: [0.5, 0.8, 0.5],
                }),
              },
            ]}
          />
        ))}
      </View>

      <View style={styles.card}>
        <Text style={styles.title}>
          ðŸŽ‰ Happy Birthday, <Text style={styles.pinkText}>Lokesh!</Text> ðŸŽ‰
        </Text>

        <Image
          source={{ uri: 'https://placehold.co/500x250/F87171/FFFFFF?text=Level+Up!+Lokesh' }}
          style={styles.image}
          onError={(e) => console.log('Image load error:', e.nativeEvent.error)}
        />

        <Text style={styles.message}>
          Hey Lokesh, Ash here! Wishing you an epic birthday filled with victories, legendary loot, and zero lag! Hope your day is as awesome as a perfect headshot!
        </Text>

        {/* Gift Box */}
        <TouchableOpacity
          onPress={handleGiftBoxClick}
          style={styles.giftBoxContainer}
          disabled={giftBoxOpen} // Disable after opening
        >
          <Animated.View style={[styles.giftBoxBase, animatedBaseStyle]} />
          <Animated.View style={[styles.giftBoxRibbonV, animatedRibbonStyle]} />
          <Animated.View style={[styles.giftBoxRibbonH, animatedRibbonStyle]} />
          <Animated.View style={[styles.giftBoxLid, animatedLidStyle]} />
        </TouchableOpacity>

        {/* Hidden Content (revealed by gift box) */}
        {giftBoxOpen && (
          <View style={styles.hiddenContent}>
            {/* Gamer Fleet Dialogue */}
            <Animated.View style={[styles.dialogueBox, animatedGamerFleetDialogueStyle]}>
              <Text style={styles.dialogueText}>
                <Text style={styles.dialogueStrong}>Gamer Fleet says:</Text> "{gamerFleetMessage}"
              </Text>
            </Animated.View>

            {/* Jack Bhaiya Dialogue */}
            <Animated.View style={[styles.dialogueBox, animatedJackBhaiyaDialogueStyle]}>
              <Text style={styles.dialogueText}>
                <Text style={styles.dialogueStrong}>Jack Bhaiya says:</Text> "{jackBhaiyaMessage}"
              </Text>
            </Animated.View>

            {/* Loading Spinner */}
            {isLoading && (
              <ActivityIndicator size="large" color="#3B82F6" style={styles.spinner} />
            )}

            {/* Share Button */}
            <TouchableOpacity onPress={onShare} style={styles.shareButton}>
              <Text style={styles.shareButtonText}>Share This Wish</Text>
              {/* Simple share icon (using text or a custom SVG if needed) */}
              <Text style={styles.shareIcon}>ðŸ”—</Text>
            </TouchableOpacity>
          </View>
        )}
      </View>
    </LinearGradient>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 16,
  },
  backgroundParticles: {
    position: 'absolute',
    top: 0,
    left: 0,
    width: '100%',
    height: '100%',
    overflow: 'hidden',
    zIndex: 0,
  },
  particle: {
    position: 'absolute',
    backgroundColor: 'rgba(255, 255, 255, 0.15)',
    borderRadius: 50,
  },
  card: {
    backgroundColor: '#ffffff',
    borderRadius: 32,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 25 },
    shadowOpacity: 0.25,
    shadowRadius: 50,
    elevation: 20, // For Android shadow
    maxWidth: 900,
    width: '100%',
    padding: 24,
    alignItems: 'center',
    minHeight: 500,
    zIndex: 1,
  },
  title: {
    fontSize: 48,
    fontWeight: '900',
    color: '#1F2937', // gray-800
    marginBottom: 24,
    lineHeight: 56, // leading-tight
    textAlign: 'center',
  },
  pinkText: {
    color: '#DB2777', // pink-600
  },
  image: {
    width: '100%',
    height: 250, // Fixed height for placeholder
    borderRadius: 16,
    marginBottom: 32,
    resizeMode: 'cover',
  },
  message: {
    fontSize: 18,
    color: '#374151', // gray-700
    marginBottom: 32,
    textAlign: 'center',
  },
  giftBoxContainer: {
    width: 200,
    height: 200,
    position: 'relative',
    marginVertical: 32,
    justifyContent: 'flex-end', // Align base to bottom
  },
  giftBoxBase: {
    width: '100%',
    height: '70%',
    backgroundColor: '#EF4444', // Red base
    borderRadius: 10,
    position: 'absolute',
    bottom: 0,
    left: 0,
  },
  giftBoxLid: {
    width: '110%',
    height: '40%',
    backgroundColor: '#DC2626', // Darker red lid
    borderRadius: 10,
    position: 'absolute',
    top: 0,
    left: '-5%',
    transformOrigin: 'bottom center', // Not directly supported by RN Animated, handled by translateY/rotateX
  },
  giftBoxRibbonV: {
    width: 30,
    height: '100%',
    backgroundColor: '#FACC15', // Yellow ribbon
    position: 'absolute',
    left: '50%',
    transform: [{ translateX: -15 }], // Half of width
    borderRadius: 5,
  },
  giftBoxRibbonH: {
    width: '100%',
    height: 30,
    backgroundColor: '#FACC15',
    position: 'absolute',
    top: '50%',
    transform: [{ translateY: -15 }], // Half of height
    borderRadius: 5,
  },
  hiddenContent: {
    width: '100%',
    alignItems: 'center',
  },
  dialogueBox: {
    backgroundColor: '#FEF2F2',
    borderLeftWidth: 5,
    borderLeftColor: '#EF4444',
    paddingVertical: 24,
    paddingHorizontal: 32,
    borderRadius: 16,
    marginTop: 24,
    textAlign: 'left',
    width: '100%',
  },
  dialogueText: {
    fontStyle: 'italic',
    color: '#4B5563',
    fontSize: 16,
  },
  dialogueStrong: {
    color: '#DC2626',
    fontWeight: '700',
  },
  shareButton: {
    backgroundColor: '#3B82F6',
    color: 'white',
    paddingVertical: 12,
    paddingHorizontal: 24,
    borderRadius: 9999,
    fontSize: 16,
    fontWeight: '600',
    marginTop: 32,
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    shadowColor: '#3B82F6',
    shadowOffset: { width: 0, height: 5 },
    shadowOpacity: 0.3,
    shadowRadius: 10,
    elevation: 5, // Android shadow
  },
  shareButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '600',
  },
  shareIcon: {
    fontSize: 20, // Adjust size as needed
    color: 'white',
  },
  spinner: {
    marginTop: 20,
  },
});

export default App;
                        
